# OBS設定ガイド

このアプリケーションを使用するには、OBSに「OSC for OBS」プラグインをインストールし、適切に設定する必要があります。

## 必要条件

1. OBS Studio
   - OSC for OBS v3.0+を使用する場合: OBS Studio バージョン28以上
   - OSC for OBS v2.7.1を使用する場合: OBS Studio バージョン27以下
2. [OSC for OBS](https://github.com/jshea2/OSC-for-OBS/releases) プラグイン
   - 最新版（v3.0+）: 新しいOBS Studio（v28+）用
   - v2.7.1: 古いOBS Studio（v27以下）用

## インストール手順

1. [OSC for OBS](https://github.com/jshea2/OSC-for-OBS/releases) の最新バージョンをダウンロードします。
2. ダウンロードしたアプリケーションを適切なフォルダに配置します：
   - Mac: アプリケーションフォルダ
   - Windows: Cドライブなどのルートフォルダ

## OSC for OBSの設定

1. OSC for OBSを起動します。
2. 以下の設定を行います：
   - OSC IN:
     - IP: 127.0.0.1
     - Port: 3333（カット番号管理システムのデフォルトポート）
   - 「Connect」ボタンをクリックして接続します。
3. OSC for OBSのコンソールタブを開き、接続が成功したことを確認します。
   - 「Successfully connected to OBS」というメッセージが表示されるはずです。
   - OSC for OBS v2.7.1の場合は、「OSC Input is listening on...」というメッセージが表示されていれば正常です。

## カット番号管理システムの設定

1. アプリケーションを起動します: `python main.py`
2. 「設定」タブを開きます。
3. 「OSC for OBSバージョン」で使用しているバージョンを選択します：
   - 「v3.0以上 (OBS v28+)」: 新しいOBS Studio（v28以上）と最新のOSC for OBSを使用している場合
   - 「v2.7.1 (OBS v27以下)」: 古いOBS Studio（v27以下）とOSC for OBS v2.7.1を使用している場合
4. 「送信方法」を選択します：
   - 「標準 (python-osc)」: 通常はこちらを使用します
   - 「カスタム (スペース区切り)」: OSC for OBS v2.7.1で「[object Object]」エラーが発生する場合に試してください
5. IPアドレスとポートを確認します（デフォルトは127.0.0.1:3333）。

## 正しいOSCコマンド

OSC for OBSで使用する主なコマンドはバージョンによって異なります：

### OSC for OBS v3.0以上
- `/startRecording` - 録画を開始します
- `/stopRecording` - 録画を停止します

### OSC for OBS v2.7.1
- `/setRecording 1` - 録画を開始します（値「1」が必要）
- `/setRecording 0` - 録画を停止します（値「0」が必要）
- `/toggleRecording` - 録画の開始/停止を切り替えます

**注意**: `/recFileName [filename]` コマンドは現在のOSC for OBSバージョンでは正しく動作しない可能性があります。このコマンドは以前は非推奨となり、現在再実装中です（PR #30参照）。

## ファイル名設定機能を使用するための設定

**重要**: 現在のOSC for OBSバージョンでは、`/recFileName`コマンドが正しく動作しない可能性があります。そのため、以下の代替方法を使用することをお勧めします：

### 方法1: OBSの録画設定でファイル名形式を直接設定する（推奨）

1. OBSを開き、「設定」>「出力」>「録画」タブを選択します。
2. 「出力モード」が「シンプル」の場合は「詳細」に変更します。
3. 「録画」タブで「ファイル名の書式」を希望のフォーマットに設定します。
   - 例: `%CCYY-%MM-%DD_%hh-%mm-%ss_{パート名}_{シーン名}_{カット番号}`
   - カット番号管理システムで使用する命名規則に合わせて設定してください。
4. 「OK」をクリックして設定を保存します。

この方法では、OSCコマンドでファイル名を動的に変更することはできませんが、一貫した命名規則を適用することができます。

### 方法2: OSC for OBSの接続設定を確認する

OSC for OBSが正常に接続されていることを確認します：

1. OSC for OBSのコンソールタブで「Successfully connected to OBS」というメッセージが表示されているか確認します。
2. 接続が確立されていない場合は、OSC for OBSを再起動し、「Connect」ボタンをクリックしてください。
3. OBSの録画設定を確認します：
   - OBSを開き、「設定」>「出力」>「録画」タブを選択します。
   - 「録画形式」が適切に設定されていることを確認します（通常は「mp4」または「mkv」）。

3. OSC for OBSの設定を確認します：
   - OSC for OBSアプリケーションが起動し、OBSに正常に接続されていることを確認します。
   - コンソールタブで送信されたコマンドとその応答を確認します。
   - `/recFileName`コマンドが送信された後にエラーメッセージがないことを確認します。
   - OSC for OBSの「File」>「OSC Tester」機能を使用して、`/recFileName "テストファイル名"`コマンドを手動で送信し、正しく動作するか確認してください。

4. OSC for OBSのバージョンを確認します：
   - OSC for OBSのバージョンが3.0以上であることを確認してください。
   - 古いバージョンでは`/recFileName`コマンドが正しく動作しない可能性があります。

5. カット番号管理システムの使用手順：
   - アプリケーションを起動し、パート名、シーン名、カット番号などの情報を入力します。
   - 録画を開始する前に、ファイル名プレビューが正しく表示されていることを確認します。
   - 録画ボタンを押して録画を開始します。
   - OSC for OBSのコンソールタブで、`/recFileName`コマンドと`/startRecording`コマンドが正しく送信されていることを確認します。

6. ファイル名の形式に関する注意点：
   - ファイル名に特殊文字（`/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`など）が含まれていないことを確認してください。
   - 非常に長いファイル名はOSによって切り詰められる可能性があります。
   - 日本語などの非ASCII文字を含むファイル名は、環境によっては正しく処理されない場合があります。

## トラブルシューティング

### ファイル名が正しく設定されない場合

**重要**: 現在のOSC for OBSバージョンでは、`/recFileName`コマンドが正しく動作しない可能性があります。このコマンドは以前は非推奨となり、現在再実装中です（PR #30参照）。そのため、OBSの設定で直接ファイル名形式を設定することをお勧めします。

1. OSC for OBSが正常に接続されていることを確認します。
   - OSC for OBSのコンソールタブで「Successfully connected to OBS」というメッセージが表示されているか確認します。
   - 接続が確立されていない場合は、OSC for OBSを再起動し、「Connect」ボタンをクリックしてください。

2. OSC for OBSのコンソールタブでエラーメッセージを確認します。
   - 「Invalid OSC command」というエラーが表示される場合は、コマンドが間違っているか、現在のバージョンでサポートされていない可能性があります。
   - 「Not connected」というエラーが表示される場合は、OSC for OBSがOBSに接続されていない可能性があります。
   - 「Error: Not implemented」というエラーが表示される場合は、そのコマンドがOSC for OBSの現在のバージョンでサポートされていない可能性があります。
   - 「Invalid) Refresh Browser Syntax」や「[object Object]」というエラーが表示される場合は、OSC for OBS v2.7.1を使用している可能性があります。この場合、コマンドの構文を変更する必要があります（下記参照）。
   
   **注意**: `/recFileName`コマンドに関するエラーが表示される場合は、このコマンドが現在のバージョンでサポートされていない可能性が高いです。OBSの設定で直接ファイル名形式を設定することをお勧めします。

### OSC for OBS v2.7.1特有の問題

OSC for OBS v2.7.1を使用している場合、以下の点に注意してください：

1. バージョン互換性の問題：
   - OSC for OBS v2.7.1はOBS Studio v27以下とobs-websocket v4.9以下でのみ動作します。
   - 最新のOBS Studio（v28以上）では、OSC for OBS v3.0以上を使用する必要があります。

2. コマンド構文が異なります：
   - `/startRecording`と`/stopRecording`の代わりに、`/setRecording 1`（開始）と`/setRecording 0`（停止）を使用します。
   - 値（1または0）を必ず指定する必要があります。空の値を送信すると「Invalid) Refresh Browser Syntax」エラーが発生します。

3. 「[object Object]」エラーの解決方法：
   - このエラーは、OSCメッセージの形式が正しくない場合に発生します。
   - カット番号管理システムの「設定」タブで、「送信方法」を「カスタム (スペース区切り)」に変更してみてください。
   - これにより、OSCメッセージが「/setRecording,1」（カンマ区切り）ではなく「/setRecording 1」（スペース区切り）の形式で送信されます。

4. カット番号管理システムの設定：
   - 「設定」タブで、「OSC for OBSバージョン」を「v2.7.1 (OBS v27以下)」に設定します。
   - これにより、録画開始コマンドと録画停止コマンドが自動的に`/setRecording`に設定されます。
   - アプリケーションは自動的に適切な値（開始時は1、停止時は0）を送信します。

5. OBSのwebsocket設定画面に表示されない問題：
   - OSC for OBS v2.7.1はOBSのwebsocket設定画面に表示されない場合がありますが、OSC for OBSのコンソールに「OSC Input is listening on...」と表示されていれば正常に動作しています。

3. OBSの録画設定を確認します：
   - OBSの「設定」>「出力」>「録画」タブで、「ファイル名の形式」や「ファイル名のテンプレート」などの設定がカスタムファイル名を上書きしていないか確認します。
   - 「録画パス」が書き込み可能なディレクトリに設定されていることを確認します。
   - 「出力モード」が「詳細」に設定されていることを確認し、「録画」タブで「ファイル名の書式」を確認してください。
   - 「ファイル名の書式」が「%CCYY-%MM-%DD %hh-%mm-%ss」などのデフォルト設定になっている場合は、一時的に空白にしてみてください。

4. コマンドの送信順序を確認します：
   - ファイル名設定コマンド（`/recFileName`）は必ず録画開始コマンド（`/startRecording`）の前に送信する必要があります。
   - デバッグのため、アプリケーションのコンソール出力で送信されるコマンドの順序を確認してください。

5. OSC for OBSのバージョンを確認します：
   - 最新バージョンのOSC for OBS（v3.0以上）を使用していることを確認します。
   - 古いバージョンでは一部の機能が異なる場合があります。

6. ファイル名の引数形式を確認します：
   - OSC for OBSのOSCテスターを使用して、`/recFileName "テストファイル名"`のように引数を二重引用符で囲んで送信してみてください。
   - 引数にスペースや特殊文字が含まれている場合は、特に引用符で囲むことが重要です。

7. OSC for OBSの設定を確認します：
   - OSC for OBSの「Settings」タブで、「OSC IN」のポートが3333に設定されていることを確認します。
   - 「OSC OUT」の設定が正しいことを確認します（通常は使用しませんが、設定が競合する可能性があります）。

8. カット番号管理システムとOSC for OBSの両方を再起動してみてください。

9. OBSを再起動してみてください。時々、OBSの再起動が必要な場合があります。

10. 最終手段として、OBSとOSC for OBSの両方を再インストールしてみてください。

## OSC for OBSのテスト方法

OSC for OBSには「OSC Tester」機能があります：

1. OSC for OBSを起動します。
2. メニューから「File」>「OSC Tester」を選択します。
3. 以下のコマンドをテストしてみてください：
   - OSC for OBS v3.0+の場合:
     - `/startRecording`
     - `/stopRecording`
   - OSC for OBS v2.7.1の場合:
     - `/setRecording 1`（録画開始）
     - `/setRecording 0`（録画停止）

## カット番号管理システムの新機能

最新バージョンのカット番号管理システムには、OSC for OBSのバージョン互換性問題を解決するための新機能が追加されています：

1. **バージョン選択機能**:
   - 「設定」タブの「OSC for OBSバージョン」で、使用しているOSC for OBSのバージョンを選択できます。
   - これにより、適切なコマンド形式が自動的に設定されます。

2. **送信方法の選択**:
   - 「標準 (python-osc)」: 通常の送信方法（OSCプロトコル準拠）
   - 「スペース区切り (/cmd value)」: OSC for OBS v2.7.1で「[object Object]」エラーが発生する場合に試す
   - 「カンマ区切り (/cmd,value)」: スペース区切りが機能しない場合の代替方法
   - 「生データ (/cmdvalue)」: 他の方法が機能しない場合の最終手段

3. **自動カット番号管理**:
   - 録画停止時に自動的にカット番号がインクリメントされます。
   - 新しいカットでは、バージョン番号が自動的に1にリセットされます。

## 参考情報

- [OSC for OBS GitHub](https://github.com/jshea2/OSC-for-OBS)
- [OBS Studio](https://obsproject.com/)
- [python-osc](https://github.com/attwad/python-osc) - OSCメッセージを送信するためのPythonライブラリ
