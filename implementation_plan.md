# カット番号管理システム 実装計画

## 1. プロジェクト概要

### 目的
アニメ制作現場でのカット番号管理を自動化し、制作効率を向上させるシステムを開発する。特にプリビズ（映像の仮組み）や3Dアニメ制作において、カットごとのデータ整理を容易にし、制作データの整合性を保つことを目指す。

### 現状と拡張方針
現在のリポジトリには、OBSにOSCメッセージを送信するための基本的なPyQt5アプリケーションが実装されています。このアプリケーションを拡張し、カット番号の自動管理、ファイル命名規則の適用、バージョン管理などの機能を追加します。

### 想定ユーザー
- アニメ制作のプリビズ担当者
- 3DCGチームのディレクター／制作進行
- 編集・演出スタッフ（カット管理の取りまとめ役）

### 主な機能
- OBSとのOSC連携によるカット番号の自動管理
- ファイル命名規則の自動適用
- 録画の開始・終了制御（既存機能の拡張）
- バージョン管理の自動化

## 2. 技術スタック

### 開発言語・フレームワーク
- **Python**: メイン開発言語
- **PyQt5**: GUIフレームワーク（既存実装と同様）
- **OSC (Open Sound Control)**: OBSとの通信プロトコル（python-oscを使用）

### 依存ライブラリ
- **python-osc**: OSCプロトコルの実装（既存実装で使用中）
- **PyQt5**: GUI実装（既存実装で使用中）
- **python-dotenv**: 設定管理（IPアドレス、ポート番号など）

### 開発ツール
- **Git**: バージョン管理
- **pip**: 依存関係管理（既存実装と同様）
- **PyInstaller/cx_Freeze**: 実行可能ファイル作成（配布用）

## 3. システムアーキテクチャ

### 現状のアーキテクチャ
現在の実装は単一のPythonファイル（main.py）で構成されており、以下の機能を提供しています：
- PyQt5を使用したシンプルなGUI
- OSC設定（IPアドレス、ポート、メッセージ、値）の入力フォーム
- RECボタンによるOSCメッセージ送信機能
- 送信状態のフィードバック表示

### 拡張後のコンポーネント構成
1. **GUIモジュール** (既存コードを拡張)
   - メインウィンドウ管理（既存）
   - 入力フォーム拡張（パート名、シーン名、バージョン名などを追加）
   - 録画制御ボタン（既存）
   - ファイル名プレビュー表示（新規）

2. **OSC通信モジュール** (既存コードを拡張)
   - OBSとの通信管理（既存）
   - OSCメッセージの送受信（既存の送信機能を拡張）
   - 死活監視機能（オプション、新規）

3. **カット番号管理モジュール** (新規)
   - カット番号の自動割り振り
   - バージョン管理
   - ファイル命名規則の適用

4. **設定管理モジュール** (新規)
   - IPアドレス・ポート設定（既存機能を拡張）
   - ファイル保存先設定
   - ユーザー設定の保存・読み込み

### データフロー
1. ユーザーがGUIからパート名、シーン名、初期バージョンを入力
2. 「REC」ボタンを押すとOSCを通じてOBSの録画を開始（既存機能を活用）
3. シーン切り替わり検出時にカット番号を自動インクリメント（新規機能）
4. 録画終了時にファイル名を自動生成し、次のバージョン番号を準備（新規機能）

## 4. 機能詳細

### 現状の機能
- **OSC通信設定**
  - IPアドレス・ポート番号の設定UI（既存）
  - OSCメッセージとその値の設定（既存）

- **録画制御**
  - RECボタンによるOSCメッセージ送信（既存）
  - 送信状態のフィードバック表示（既存）

### 拡張する機能

#### OBS連携機能
- **OSC通信設定の拡張**
  - 既存のIPアドレス・ポート番号設定UIを活用
  - 通信テスト機能（新規）
  - 死活監視機能（オプション、新規）

- **録画制御の拡張**
  - 既存のRECボタン機能を活用
  - 録画状態の監視機能（新規）

- **シーン切り替え検出**
  - OBSからのシーン切り替え通知の受信（新規）
  - カット番号の自動インクリメント（新規）

#### ファイル命名管理（新規）
- **命名規則**: `{パート名}_{シーン名}_{カット番号}_{バージョン名}`
- **自動フォーマット機能**
  - 入力完了時のリアルタイムプレビュー
  - 特殊文字の自動置換（ファイル名に使用できない文字の処理）

- **バージョン管理**
  - 録画終了時のバージョン自動更新
  - バージョン履歴の管理

#### ユーザーインターフェースの拡張
- **メイン画面**
  - 既存のOSC設定フォームを維持
  - パート名入力フィールド（新規）
  - シーン名入力フィールド（新規）
  - カット番号表示（自動管理・手動調整可能、新規）
  - バージョン名入力フィールド（新規）
  - ファイル名プレビュー表示（新規）
  - 既存のRECボタンを活用

- **設定画面**
  - 既存のOSC設定を活用
  - ファイル保存先設定（新規）
  - その他の環境設定（新規）

## 5. 実装計画

### 現状
- 単一ファイル（main.py）でOSC送信機能を実装
- PyQt5を使用したシンプルなGUI
- 基本的なOSC設定と送信機能

### フェーズ1: コードリファクタリングと基本設計
- 既存コードの分析と理解
- モジュール構造への移行計画
- 追加機能の詳細設計
- 既存機能を維持しながらのリファクタリング

### フェーズ2: コア機能実装
- 既存のOSC通信機能を拡張
- カット番号管理ロジックの実装
- ファイル命名規則の実装
- 設定管理機能の実装

### フェーズ3: GUI拡張
- 既存のGUIを維持しながらの拡張
- 追加入力フォームの実装（パート名、シーン名など）
- ファイル名プレビュー機能の実装
- 既存の録画制御ボタンの機能拡張

### フェーズ4: 統合・テスト
- 各モジュールの統合
- OBSとの連携テスト
- ユーザーフィードバックの収集
- バグ修正・機能調整

### フェーズ5: パッケージング・配布
- 実行可能ファイルの作成
- インストーラーの作成（必要に応じて）
- ドキュメント作成
- 配布準備

## 6. ディレクトリ構造

### 現状の構造
```
cut-numbering-manager/
├── main.py              # アプリケーション全体（単一ファイル）
├── requirements.txt     # 依存ライブラリ
└── README.md            # プロジェクト説明
```

### 提案する拡張後の構造
```
cut-numbering-manager/
├── main.py              # アプリケーションのエントリーポイント（既存ファイルを拡張）
├── gui/
│   ├── __init__.py
│   ├── main_window.py   # メインウィンドウ（既存GUIを拡張）
│   ├── settings_dialog.py # 設定ダイアログ
│   └── resources/       # アイコン等のリソース
├── core/
│   ├── __init__.py
│   ├── cut_manager.py   # カット番号管理
│   ├── file_namer.py    # ファイル命名
│   └── version_manager.py # バージョン管理
├── osc/
│   ├── __init__.py
│   ├── client.py        # OSC送信（既存機能を移行）
│   ├── server.py        # OSC受信
│   └── monitor.py       # 死活監視
├── config/
│   ├── __init__.py
│   └── settings.py      # 設定管理
├── tests/               # テストコード
├── resources/           # リソースファイル
├── requirements.txt     # 依存ライブラリ（既存）
├── README.md            # プロジェクト説明（既存）
└── LICENSE              # ライセンス
```

**注意**: 既存の機能を損なわないよう、段階的にリファクタリングを行います。最初は単一ファイル構造を維持しながら機能を追加し、その後モジュール化を進めることも検討します。

## 7. 参考資料

- **既存のリポジトリ**
  - https://github.com/bassdrum-org/cut-numbering-manager
  - 現在のOSC送信アプリケーションのコードベース

- **TouchDesignerで作成された既存アプリ**
  - https://drive.google.com/drive/folders/1mDHQXf8ptGGTjeOY0xwTfkW0jLwYSyER
  - 参考にすべき機能と実装方法

- **OBSプラグイン**
  - https://github.com/jshea2/OSC-for-OBS
  - OBSとのOSC通信に必要なプラグイン

- **実際のOBS録画映像サンプル**
  - https://drive.google.com/drive/folders/1b5XNSp-gbvYxeItBzdlAuoNMnvjVnnUJ
  - 実際の使用シナリオの理解に役立つサンプル

## 8. 今後の拡張可能性

- **複数OBSインスタンスの管理**
  - 複数カメラからの同時録画対応

- **クラウド連携**
  - 録画ファイルの自動アップロード
  - チーム間での共有機能

- **高度な自動化**
  - AIによるシーン検出
  - 音声認識によるタイムコード付与

- **他ツールとの連携**
  - 編集ソフトへの直接エクスポート
  - プロジェクト管理ツールとの連携

## 9. 実装アプローチ

### 段階的実装戦略
1. **最小限の機能拡張から開始**
   - 既存のOSC送信機能を維持しながら、最小限の追加機能（パート名、シーン名入力など）を実装
   - ユーザーが現在の機能を引き続き使用できるようにする

2. **モジュール化の段階的導入**
   - 機能追加と並行して、コードベースを徐々にモジュール化
   - 各機能が安定したら、対応するモジュールに移行

3. **テストと検証の重視**
   - 各機能追加後に動作検証を行い、既存機能が損なわれていないことを確認
   - ユーザーフィードバックを早期に取り入れる

### 開発プロセス
- **イテレーティブな開発**
  - 小さな機能単位で実装・テスト・リリースのサイクルを繰り返す
  - 定期的なユーザーフィードバックを取り入れる

- **バックワードコンパティビリティの維持**
  - 既存のユーザーが混乱なく新機能を利用できるようにする
  - 設定ファイルなどの互換性を保つ
